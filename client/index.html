<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
  <script src="./js/index.js" defer></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <title>Frontend</title>

  <style>
    #chart text {
      fill: black;
      font: 10px sans-serif;
      text-anchor: end;
    }

    .axis text {
      font: 10px sans-serif;
    }

    .axis path, .axis line {
      fill: none;
      /*stroke: #fff;*/
      shape-rendering: crispEdges;
    }

    body {
      /*background: #1a1a1a;*/
      color: #eaeaea;
      padding: 10px;
    }

    path {
      stroke: steelblue;
      stroke-width: 2;
      fill: none;
    }
  </style>
</head>
<body>


    <div id="chart" style="height:600px;width:600px">
      <div class="innerCont" style="overflow: auto; top:100px; left: 400px; height:91% ; Width:100% ;position: relative;overflow: hidden;"></div>
    </div>
</body>
  <script type="text/javascript">
    var salesData;
    var chartInnerDiv = '<div class="innerCont" style="overflow: auto;top:100px; left: 400px; height:91% ; Width:100% ;position: relative;overflow: hidden;"/>';
    var truncLengh = 30;

    $(document).ready(function () {
      Plot();
    });

    function Plot() {
      TransformChartData(chartData, chartOptions, 0);
      BuildPie("chart", chartData, chartOptions, 0)
    }

    function BuildPie(id, chartData, options, level) {
      var xVarName;
      var divisionRatio = 2.5;
      var legendoffset = (level == 0) ? 0 : -40;

      d3.selectAll("#" + id + " .innerCont").remove();
      $("#" + id).append(chartInnerDiv);

      var yVarName = options[0].yaxis;
      var width = $($("#" + id + " .innerCont")[0]).outerWidth();
      var height = $($("#" + id + " .innerCont")[0]).outerHeight();
      var radius = Math.min(width, height) / divisionRatio;

      if (level == 1) {
        xVarName = options[0].xaxisl1;
      }
      else {

        xVarName = options[0].xaxis;
      }
      var rcolor = d3.scaleOrdinal().range(runningColors);

      var arc = d3.arc()
              .outerRadius(radius)
              .innerRadius(radius - 200);

      var arcOver = d3.arc().outerRadius(radius + 20).innerRadius(radius - 180);

      var chart = d3.select("#" + id + " .innerCont")
              .append("svg")  //append svg element inside #chart
              .attr("width", width)    //set width
              .attr("height", height)  //set height
              .append("g")
              .attr("transform", "translate(" + (width / divisionRatio) + "," + ((height / divisionRatio) + 30) + ")");

      var pie = d3.pie()
              .sort(null)
              .value(function (d) {
                return d.total;
              })(runningData);

      var g = chart.selectAll(".arc")
              .data(pie)
              .enter().append("g")
              .attr("class", "arc");

      var count = 0;

      var path = g.append("path")
              .attr("d", arc)
              .attr("id", function () { return "arc-" + (count++); })
              .style("opacity", function (d) {
                return d.data["op"];
              });

      path.on("mouseenter", function (d) {
        d3.select(this)
                .attr("stroke", "white")
                .transition()
                .duration(200)
                .attr("d", arcOver)
                .attr("stroke-width", 1);
      })
              .on("mouseleave", function (d) {
                d3.select(this).transition()
                        .duration(200)
                        .attr("d", arc)
                        .attr("stroke", "none");
              })

      path.append("svg:title")
              .text(function (d) {
                return d.data[xVarName];
              });

      path.style("fill", function (d) {
        return rcolor(d.data[xVarName]);
      }).transition().duration(1000).attrTween("d", tweenIn)


      g.append("text")
              .attr("transform", function (d) { return "translate(" + arc.centroid(d) + ")"; })
              .attr("dy", .35)
              .style("text-anchor", "middle")
              .style("opacity", 1)
              //.text(function (d) {

                //return d.data[yVarName];
              //});

      count = 0;
      var legend = chart.selectAll(".legend")
              .data(runningData).enter()
              .append("g").attr("class", "legend")
              .attr("legend-id", function (d) {
                return count++;
              })
              .attr("transform", function (d, i) {
                return "translate(15," + (parseInt("-" + (runningData.length * 10)) + i * 28 + legendoffset) + ")";
              })
              .style("cursor", "pointer")


      var leg = legend.append("rect");

      leg.attr("x", width / 2)
              .attr("width", 18).attr("height", 18)
              .style("fill", function (d) {
                return rcolor(d[yVarName]);
              })
              .style("opacity", function (d) {
                return d["op"];
              });
      legend.append("text").attr("x", (width / 2) - 5)
              .attr("y", 9).attr("dy", .35)
              .style("text-anchor", "end").text(function (d) {
        return d.title;
      });

      leg.append("svg:title")
              .text(function (d) {
                return d["title"] + " (" + d[yVarName] + ")";
              });

      function tweenOut(data) {
        data.startAngle = data.endAngle = (2 * Math.PI);
        var interpolation = d3.interpolate(this._current, data);
        this._current = interpolation(0);
        return function (t) {
          return arc(interpolation(t));
        };
      }

      function tweenIn(data) {
        var interpolation = d3.interpolate({ startAngle: 0, endAngle: 0 }, data);
        this._current = interpolation(0);
        return function (t) {
          return arc(interpolation(t));
        };
      }

    }

    function TransformChartData(chartData, opts, level, filter) {
      var result = [];
      var resultColors = [];
      var counter = 0;
      var hasMatch;
      var xVarName;
      var yVarName = opts[0].yaxis;

      if (level == 1) {
        xVarName = opts[0].xaxisl1;
        for (var i in chartData) {
           hasMatch = false;
          for (var index = 0; index < result.length; ++index) {
            var data = result[index];

            if ((data[xVarName] == chartData[i][xVarName]) && (chartData[i][opts[0].xaxis]) == filter) {
              result[index][yVarName] = result[index][yVarName] + chartData[i][yVarName];
              hasMatch = true;
              break;
            }

          }
          if ((hasMatch == false) && ((chartData[i][opts[0].xaxis]) == filter)) {
            if (result.length < 9) {
              let ditem = {}
              ditem[xVarName] = chartData[i][xVarName];
              ditem[yVarName] = chartData[i][yVarName];
              console.log(chartData[i][xVarName])
              ditem["title"] = chartData[i][xVarName];
              ditem["op"] = 1.0 - parseFloat("0." + (result.length));
              result.push(ditem);

              resultColors[counter] = opts[0].color[0][chartData[i][opts[0].xaxis]];

              counter += 1;
            }
          }
        }
      }
      else {
        xVarName = opts[0].xaxis;
        for (var i in chartData) {
          hasMatch = false;
          for (var index = 0; index < result.length; ++index) {
            var data = result[index];
            if (data[xVarName] == chartData[i][xVarName]) {
             // result[index][yVarName] = result[index][yVarName] + chartData[i][yVarName];
              hasMatch = true;
              break;
            }
          }
          if (hasMatch == false) {
            let ditem = {};
            ditem[xVarName] = chartData[i][xVarName];
            ditem[yVarName] = chartData[i][yVarName];
            ditem["title"] = opts[0].captions != undefined ? opts[0].captions.find((op) => op['acronym'] == chartData[i][xVarName])['title']  : "";
            ditem["op"] = 1;
            ditem["total"] = chartData.filter(c => c['moduleGroup'] == ditem[xVarName]).map(c => c.ects).reduce((a, b) => a + b, 0)
            result.push(ditem);

            resultColors[counter] = opts[0].color != undefined ? opts[0].color[0][chartData[i][xVarName]] : "";

            counter += 1;
          }
        }
      }
      console.log(result)


      runningData = result;
      runningColors = resultColors;
      return;
    }

    chartOptions = [{
      "captions": [
      {
        "acronym": "A1",
        "title": "Mathematische Grundlagen"
      },
      {
        "acronym": "A2",
        "title": "Informatik"
      },
      {
        "acronym": "A3",
        "title": "Angewandte Informatik"
      },
      {
        "acronym": "A5",
        "title": "Überfachliche Qualifikationen"
      },
      {
        "acronym": "A6",
        "title": "Seminare und Projekte"
      },
      {
        "acronym": "A7",
        "title": "Bachelorarbeit"
      }],
      "color": [{ "A1": "#FFA500", "A2": "#0070C0", "A3": "#ff0000","A4":"#AE79D1","A5":"#79C8D1","A6":"#79D194","A7":"#C8D179"  }],
      "xaxis": "moduleGroup",
      "xaxisl1": "moduleName",
      "yaxis": "moduleAcronym",
    }]

    var chartData = [{
            "moduleName": "Stat-B-01",
            "moduleAcronym": "Methoden der Statistik I",
            "ects": 6,
            "moduleGroup": "A1"
    },
    {
      "moduleName": "Stat-B-02",
            "moduleAcronym": "Methoden der Statistik II",
            "ects": 6,
            "moduleGroup": "A1"
    },
    {
      "moduleName": "WiMa-B-01b",
            "moduleAcronym": "Mathematik in den Wirtschaftswissenschaften I",
            "ects": 4,
            "moduleGroup": "A1"
    },
    {
      "moduleName": "GdI-MfI-1",
            "moduleAcronym": "Mathematik für Informatik 1 (Aussagen- u. Prädikatenlogik)",
            "ects": 6,
            "moduleGroup": "A1"
    },
    {
      "moduleName": "KTR-MfI-2",
            "moduleAcronym": "Mathematik für Informatik 2 (Lineare Algebra)",
            "ects": 6,
            "moduleGroup": "A1"
    },
    {
      "moduleName": "AI-AuD-B",
            "moduleAcronym": "Algorithmen und Datenstrukturen",
            "ects": 6,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "MOBI-DBS-B",
            "moduleAcronym": "Datenbanksysteme",
            "ects": 6,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "DSG-EiAPS-B",
            "moduleAcronym": "Einführung in Algorithmen, Programmierung und Software",
            "ects": 6,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "DSG-JaP-B",
            "moduleAcronym": "Java Programmierung",
            "ects": 3,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "DSG-AJP-B",
            "moduleAcronym": "Fortgeschrittene Java Programmierung",
            "ects": 3,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "GdI-GTI-B",
            "moduleAcronym": "Grundlagen der Theoretischen Informatik",
            "ects": 6,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "SWT-FSE-B",
            "moduleAcronym": "Foundations of Software Engineering",
            "ects": 6,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "PSI-EiRBS-B",
            "moduleAcronym": "Einführung in Rechner- und Betriebssysteme",
            "ects": 6,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "PSI-IntroSP-B",
            "moduleAcronym": "Introduction to Security and Privacy",
            "ects": 6,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "DSG-PKS-B",
            "moduleAcronym": "Programmierung komplexer interagierender Systeme",
            "ects": 3,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "GdI-IFP-B",
            "moduleAcronym": "Introduction to Functional Programming",
            "ects": 6,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "GdI-MTL",
            "moduleAcronym": "Modal and Temporal Logic",
            "ects": 6,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "KTR-Datkomm-B",
            "moduleAcronym": "Datenkommunikation",
            "ects": 6,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "MOBI-MSS-B",
            "moduleAcronym": "Mobility in Software Systems",
            "ects": 6,
            "moduleGroup": "A2"
    },
    {
      "moduleName": "AI-KI-B",
            "moduleAcronym": "Einführung in die Künstliche Intelligenz",
            "ects": 6,
            "moduleGroup": "A3"
    },
    {
      "moduleName": "HCI-IS-B",
            "moduleAcronym": "Interaktive Systeme",
            "ects": 6,
            "moduleGroup": "A3"
    },
    {
      "moduleName": "KInf-GeoInf-B",
            "moduleAcronym": "Geoinformationssysteme",
            "ects": 6,
            "moduleGroup": "A3"
    },
    {
      "moduleName": "MI-EMI-B",
            "moduleAcronym": "Einführung in die Medieninformatik",
            "ects": 6,
            "moduleGroup": "A3"
    },
    {
      "moduleName": "VIS-GIV-B",
            "moduleAcronym": "Grundlagen der Informationsvisualisierung",
            "ects": 6,
            "moduleGroup": "A3"
    },
    {
      "moduleName": "KInf-DigBib-B",
            "moduleAcronym": "Digitale Bibliotheken und Social Computing",
            "ects": 6,
            "moduleGroup": "A3"
    },
    {
      "moduleName": "MI-WebT-B",
            "moduleAcronym": "Web-Technologien",
            "ects": 6,
            "moduleGroup": "A3"
    },
    {
      "moduleName": "HCI-KS-B",
            "moduleAcronym": "Kooperative Systeme",
            "ects": 6,
            "moduleGroup": "A3"
    },
    {
      "moduleName": "HCI-US-B",
            "moduleAcronym": "Ubiquitäre Systeme",
            "ects": 6,
            "moduleGroup": "A3"
    },
    {
      "moduleName": "SME-Phy-B",
            "moduleAcronym": "Physical Computing",
            "ects": 6,
            "moduleGroup": "A3"
    },
    {
      "moduleName": "EESYS-GEI-B",
            "moduleAcronym": "Grundlagen der Energieinformatik",
            "ects": 6,
            "moduleGroup": "A3"
    },
    {
      "moduleName": "MI-WAIAI-B",
            "moduleAcronym": "Einführung in das wissenschaftliche Arbeiten für Informatik und Angewandte Informatik",
            "ects": 3,
            "moduleGroup": "A5"
    },
    {
      "moduleName": "PSI-EDS-B",
            "moduleAcronym": "Ethics for the Digital Society",
            "ects": 3,
            "moduleGroup": "A5"
    },
    {
      "moduleName": "EESYS-IITP-B",
            "moduleAcronym": "Internationales IT-Projektmanagement",
            "ects": 6,
            "moduleGroup": "A5"
    },
    {
      "moduleName": "HCI-DISTP-B",
            "moduleAcronym": "Design Interaktiver Systeme: Theorie und Praxis",
            "ects": 3,
            "moduleGroup": "A5"
    },
    {
      "moduleName": "KogSys-GAI-B",
            "moduleAcronym": "Genderaspekte in der Informatik",
            "ects": 3,
            "moduleGroup": "A5"
    },
    {
      "moduleName": "HCI-Sem-B",
            "moduleAcronym": "Bachelorseminar Mensch-Computer-Interaktion",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "KInf-Seminar-B",
            "moduleAcronym": "Bachelorseminar Kulturinformatik",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "KogSys-Sem-B",
            "moduleAcronym": "Bachelorseminar Kognitive Systeme",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "MI-Sem-B",
            "moduleAcronym": "Bachelorseminar zur Medieninformatik",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "SME-Sem-B",
            "moduleAcronym": "Bachelorseminar zu Smart Environments",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "VIS-Sem-B",
            "moduleAcronym": "Bachelorseminar Informationsvisualisierung",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "DSG-Sem-B",
            "moduleAcronym": "Bachelorseminar zur Praktischen Informatik",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "GdI-Sem-B",
            "moduleAcronym": "Bachelorseminar Grundlagen der Informatik",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "KTR-Sem-B",
            "moduleAcronym": "Bachelorseminar zu Kommunikationssystemen und Rechnernetzen",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "MOBI-SEM-B",
            "moduleAcronym": "Bachelor-Seminar Mobile Software Systems",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "PSI-Sem-B",
            "moduleAcronym": "Seminar Security and Privacy Foundations",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "SWT-SEM-B",
            "moduleAcronym": "Seminar Software Engineering and Programming Languages",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "WI-Seminar-B",
            "moduleAcronym": "Bachelorseminar aus der Fächergruppen Wirtschaftsinformatik",
            "ects": 3,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "HCI-Proj-B",
            "moduleAcronym": "Projekt Mensch-Computer-Interaktion",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "KInf-Projekt-B",
            "moduleAcronym": "Bachelorprojekt Kulturinformatik",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "KogSys-Proj-B",
            "moduleAcronym": "Bachelor-Projekt Kognitive Systeme",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "MI-Proj-B",
            "moduleAcronym": "Projekt zur Medieninformatik [Bachelor]",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "SME-Projekt-B",
            "moduleAcronym": "Bachelorprojekt zu Smart Environments",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "DSG-Project-B",
            "moduleAcronym": "Bachelorprojekt zur Praktischen Informatik",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "GdI-Proj-B",
            "moduleAcronym": "Bachelorprojekt Grundlagen der Informatik",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "KTR-Proj",
            "moduleAcronym": "Projekt Kommunikationsnetze und -dienste",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "MOBI-Proj-B",
            "moduleAcronym": "Bachelor Project Mobile Software Systems",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "PSI-ProjectPAD",
            "moduleAcronym": "Project Practical Attacks and Defenses",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "SWT-SWL-B",
            "moduleAcronym": "Software Engineering Lab",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "SWT-SWP-B",
            "moduleAcronym": "Software Engineering Project",
            "ects": 6,
            "moduleGroup": "A6"
    },
    {
      "moduleName": "AI-Thesis-B",
            "moduleAcronym": "Bachelorarbeit im Studiengang Angewandte Informatik",
            "ects": 12,
            "moduleGroup": "A7"
    }
    ];

  </script>
</html>